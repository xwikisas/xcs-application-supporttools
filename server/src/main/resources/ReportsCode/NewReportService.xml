<?xml version="1.0" encoding="UTF-8"?>

<xwikidoc>
  <web>ReportsCode</web>
  <name>NewReportService</name>
  <language/>
  <defaultLanguage>en</defaultLanguage>
  <translation>0</translation>
  <parent/>
  <creator>xwiki:XWiki.Admin</creator>
  <author>xwiki:XWiki.Admin</author>
  <customClass/>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <creationDate>1420066800000</creationDate>
  <date>1420066800000</date>
  <contentUpdateDate>1420066800000</contentUpdateDate>
  <version>1.1</version>
  <title/>
  <defaultTemplate/>
  <validationScript/>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>false</hidden>
  <content>{{groovy}}
if (request.id) {
 def fileupload = xwiki.getPlugin("fileupload")
 fileupload.loadFileList()

 println request.client
 println request.id
 println request.getRemoteAddr()
 println request.wiki
 def bytes = fileupload.getFileItemData("file")
 def reportDoc = xwiki.getDocument("Reports.${request.client}${request.id}")
 if (reportDoc.getObject("ReportsCode.ReportsClass"))
  reportDoc.use("ReportsCode.ReportsClass")
 else  
  reportDoc.use(reportDoc.newObject("ReportsCode.ReportsClass"))
 reportDoc.set("client", request.client)
 reportDoc.set("id", request.id)
 def reportDate = new Date();
 if (request.id) {
   reportDate = new Date(Long.parseLong(request.id))
 }
 reportDoc.set("reportDate", reportDate)
 reportDoc.set("wiki", request.wiki)
 reportDoc.set("xwikiVersion", request.xwikiVersion)
 reportDoc.set("reportVersion", request.reportVersion)
 reportDoc.set("ip", request.getRemoteAddr())
 reportDoc.set("host", request.getHeader("Host"))
 xcontext.context.setUser(doc.getAuthor())
 reportDoc.saveAsAuthor("Created report")
 reportDoc.addAttachment("report.zip", bytes)
 reportDoc.saveAsAuthor("Added report file")
 println "[[${reportDoc.fullName}]]";
} else {
 println """
{{html clean="false" wiki="true"}}
&lt;form action="" method="post" enctype="multipart/form-data"&gt;
; File:
: &lt;input type="file" name="file" /&gt;

; Client: 
: &lt;input type="text" name="client" /&gt;

; Id: 
: &lt;input type="text" name="id" /&gt;

; Wiki: 
: &lt;input type="text" name="wiki" /&gt;

; XWiki version: 
: &lt;input type="text" name="xwikiVersion" /&gt;

; Report Version: 
: &lt;input type="text" name="reportVersion" /&gt;
&lt;input type="submit" class="button" value="Upload" /&gt;
&lt;/form&gt;
{{/html}}
 """

}</content>
</xwikidoc>
