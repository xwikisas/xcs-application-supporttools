<?xml version="1.0" encoding="UTF-8"?>

<xwikidoc>
  <web>SupportToolsCode</web>
  <name>SendReport</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <parent>WebHome</parent>
  <creator>xwiki:XWiki.Admin</creator>
  <author>xwiki:XWiki.Admin</author>
  <customClass/>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <creationDate>1420066800000</creationDate>
  <date>1420066800000</date>
  <contentUpdateDate>1420066800000</contentUpdateDate>
  <version>1.1</version>
  <title>XWiki SAS Support Tool - Send Report</title>
  <defaultTemplate/>
  <validationScript/>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>true</hidden>
  <content>
This tools allows to send a report about your installation to XWiki SAS' support team. All information will be kept strictly confidential.

{{groovy}}  
if (request.confirm) {
def st = xwiki.parseGroovyFromPage("SupportToolsCode.Groovy")
st.setXWiki(xwiki, xcontext, services)
st.startJob()
try {
st.addXWikiFile("xwiki.cfg")
st.addXWikiFile("xwiki.properties")
st.addXWikiFile("hibernate.cfg.xml")
st.addXWikiFile("web.xml")
st.addXWikiPage("Admin.CheckXWikiConfig")
st.addXWikiPage("Admin.CheckProgrammingRights")
st.addXWikiPage("Admin.ShowRights")
st.addXWikiPage("Admin.UsedSpace")
st.addXWikiPage("Admin.CheckDBEncoding")
st.addXWikiPage("Admin.CheckIndexes")
st.addWEBINFListing()
st.addServerCommand("xwiki-workdir", "ls -lR /usr/local/xwiki-workdir/")
st.addServerCommand("tomcat-server.xml", "cat /usr/local/tomcat/conf/server.xml")
st.addServerCommand("tomcat-web.xml", "cat /usr/local/tomcat/conf/web.xml")
st.addServerCommand("tomcat-context.xml", "cat /usr/local/tomcat/conf/context.xml")
st.addServerCommand("top", "top -b -n 3 -d0.5")
st.addServerCommand("df", "df -h")
st.addServerCommand("javaThreads", "ps -L -C java")
st.addServerCommand("log-catalina", "tail -10000 /usr/local/tomcat/logs/catalina.out")st.makeZip();
// the following commands not work because of process rights on the server
st.addServerCommand("xinit", "/etc/init.d/xwiki.sh show-report")
st.addServerCommand("apache2", "cat /etc/apache2/*.conf")
st.addServerCommand("apache2sites", "cat /etc/apache2/sites-enabled/*")

if (st.sendFile())
   println "The report has been sent to XWiki SAS successfully.";
else  
   println """The report could not be sent to XWiki SAS. You can download the report below and send it by email to "support@xwiki.com"."""
  
} finally {
  st.endJob();
}

println """

[[Download Report&gt;&gt;DownloadReport||queryString="id=${st.jobId}"]]

"""

println """== Debug ==
  
${st.debugMsg}

"""
} else {
 println """[[Confirm sending report&gt;&gt;||queryString="confirm=1"]]"""
}
  
{{/groovy}}
</content>
</xwikidoc>
